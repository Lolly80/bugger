// Generated by CoffeeScript 1.6.1
(function() {
  var debugBrk, entryScript, failedToStart, net, requireScript, spawn;

  requireScript = require('../bugger').requireScript;

  spawn = require('child_process').spawn;

  net = require('net');

  if (!module.parent) {
    debugBrk = process.argv[2] === 'true';
    entryScript = process.argv[3];
    failedToStart = setTimeout(function() {
      console.log('Waited a second, noone connected to this debugging session.');
      console.log('Maybe trying again is enough..?');
      throw new Error('Script failed to start');
    }, 1000);
    process.once('SIGUSR2', function() {
      clearTimeout(failedToStart);
      return requireScript(entryScript, debugBrk);
    });
  }

  module.exports = function(entryScript, debugPort, debugBrk, argv_, cb) {
    var args, entryScriptProc;
    args = ["--debug=" + debugPort, module.filename, debugBrk.toString(), entryScript].concat(argv_.splice(1));
    entryScriptProc = spawn(process.execPath, args);
    entryScriptProc.stdout.pipe(process.stdout);
    entryScriptProc.stderr.pipe(process.stderr);
    return setTimeout(function() {
      var debugConnection;
      return debugConnection = net.connect(debugPort, function() {
        process.kill(entryScriptProc.pid, 'SIGUSR2');
        return cb({
          entryScriptProc: entryScriptProc,
          debugConnection: debugConnection
        });
      });
    }, 100);
  };

}).call(this);
